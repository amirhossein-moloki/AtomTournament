# گزارش ممیزی امنیتی پروژه

تاریخ گزارش: ۲۰۲۴/۰۵/۲۱

## خلاصه مدیریتی

این گزارش نتایج یک ممیزی امنیتی متمرکز بر کنترل دسترسی (Access Control) در API های پروژه را ارائه می‌دهد. در طی این بررسی، چندین آسیب‌پذیری با درجه اهمیت **متوسط** شناسایی شد که عمدتاً مربوط به افشای اطلاعات (Information Disclosure) به کاربران غیرمجاز بود. تمام آسیب‌پذیری‌های شناسایی شده، اصلاح و راه‌حل‌های امنیتی مناسب برای آن‌ها پیاده‌سازی گردید.

## آسیب‌پذیری‌های شناسایی شده و راه‌حل‌ها

### ۱. افشای لیست کاربران و شمارش کاربر (User Enumeration)

- **ماژول:** `users`
- **اندپوینت:** `GET /api/users/`
- **توضیح مشکل:** این اندپوینت به هر کاربر احراز هویت شده‌ای اجازه می‌داد تا لیست کامل کاربران سیستم را به همراه اطلاعات عمومی پروفایل آن‌ها (مانند `id`, `username`, `score`, `rank`) مشاهده کند. این آسیب‌پذیری می‌توانست برای جمع‌آوری اطلاعات درباره کاربران و شمارش آن‌ها مورد سوءاستفاده قرار گیرد.
- **اهمیت:** متوسط
- **راه‌حل اعمال شده:** دسترسی به این اندپوینت به **ادمین‌ها** (`IsAdminUser`) محدود شد.

### ۲. مشاهده پروفایل عمومی کاربران توسط کاربران مهمان

- **ماژول:** `users`
- **اندپوینت:** `GET /api/users/{pk}/`
- **توضیح مشکل:** این اندپوینت به هر کاربری (حتی کاربران مهمان و احراز هویت نشده) اجازه می‌داد تا پروفایل عمومی سایر کاربران را مشاهده کند.
- **اهمیت:** پایین
- **راه‌حل اعمال شده:** دسترسی به این اندپوینت به **کاربران احراز هویت شده** (`IsAuthenticated`) محدود شد.

### ۳. دسترسی غیرمجاز به تاریخچه مسابقات کاربران

- **ماژول:** `users`
- **اندپوینت:** `GET /api/users/{pk}/match-history/`
- **توضیح مشکل:** هر کاربر احراز هویت شده‌ای می‌توانست با دانستن `ID` یک کاربر دیگر، لیست کامل تاریخچه مسابقات او را مشاهده کند.
- **اهمیت:** متوسط
- **راه‌حل اعمال شده:**
    - `UserMatchHistoryView` حذف شد.
    - یک `action` جدید به نام `match_history` به `UserViewSet` اضافه شد.
    - دسترسی به این `action` با پرمیشن موجود `IsOwnerOrAdmin` محدود شد، بنابراین فقط خود کاربر یا ادمین می‌تواند تاریخچه مسابقات را ببیند.
    - URL مربوطه در `users/urls.py` اصلاح شد.

### ۴. افشای لیست کامل مسابقات به کاربران مهمان

- **ماژول:** `tournaments`
- **اندپوینت:** `GET /api/tournaments/matches/`
- **توضیح مشکل:** این اندپوینت به هر کاربری (حتی مهمان) اجازه می‌داد لیست کامل تمام مسابقات انجام شده در پلتفرم را به همراه جزئیات شرکت‌کنندگان آن‌ها مشاهده کند.
- **اهمیت:** متوسط
- **راه‌حل اعمال شده:** دسترسی به اکشن‌های `list` و `retrieve` در `MatchViewSet` به **کاربران احراز هویت شده** (`IsAuthenticated`) محدود شد.

### ۵. افشای لیست کامل تیم‌ها به کاربران مهمان

- **ماژول:** `teams`
- **اندپوینت:** `GET /api/teams/`
- **توضیح مشکل:** این اندپوینت به هر کاربری (حتی مهمان) اجازه می‌داد لیست کامل تمام تیم‌های سیستم را به همراه جزئیات و لیست اعضای آن‌ها مشاهده کند.
- **اهمیت:** متوسط
- **راه‌حل اعمال شده:** دسترسی به اکشن‌های `list` و `retrieve` در `TeamViewSet` به **کاربران احراز هویت شده** (`IsAuthenticated`) محدود شد.

### ۶. دسترسی غیرمجاز به تاریخچه مسابقات تیم‌ها

- **ماژول:** `teams`
- **اندپوینت:** `GET /api/teams/{pk}/match-history/`
- **توضیح مشکل:** هر کاربر احراز هویت شده‌ای می‌توانست با دانستن `ID` یک تیم، لیست کامل تاریخچه مسابقات آن تیم را مشاهده کند.
- **اهمیت:** متوسط
- **راه‌حل اعمال شده:**
    - `TeamMatchHistoryView` حذف شد.
    - یک `action` جدید به نام `match_history` به `TeamViewSet` اضافه شد.
    - یک پرمیشن سفارشی جدید به نام `IsTeamMemberOrAdmin` ایجاد شد تا دسترسی فقط به اعضای تیم و ادمین‌ها محدود شود.
    - URL مربوطه در `teams/urls.py` اصلاح شد.

## وضعیت سایر ماژول‌های بررسی شده

- **ماژول `wallet`:** کنترل دسترسی در این ماژول به درستی پیاده‌سازی شده و هیچ آسیب‌پذیری یافت نشد.
- **ماژول `chat`:** کنترل دسترسی در این ماژول به درستی پیاده‌سازی شده و هیچ آسیب‌پذیری یافت نشد.
- **ماژول `support`:** کنترل دسترسی در این ماژول به درستی پیاده‌سازی شده و هیچ آسیب‌پذیری یافت نشد.

## نتیجه‌گیری

با اعمال تغییرات فوق، سطح امنیتی کنترل دسترسی پروژه به طور قابل توجهی بهبود یافته و از افشای اطلاعات حساس به کاربران غیرمجاز جلوگیری شده است. توصیه می‌شود این الگوهای امنیتی (استفاده از پرمیشن‌های دقیق و فیلتر کردن کوئری‌ها بر اساس `request.user`) در توسعه آینده پروژه نیز به کار گرفته شوند.
