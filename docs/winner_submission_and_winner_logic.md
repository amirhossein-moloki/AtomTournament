# ارسال ویدیو قهرمان تورنمنت و منطق تعیین برندگان

این راهنما نحوه‌ی ارسال ویدیو توسط برنده تورنمنت و همچنین منطق انتخاب برندگان در بک‌اند را برای تیم فرانت توضیح می‌دهد. تمام مسیرها با پیشوند پایه‌ی `/api/tournaments/` در دسترس هستند.

## ۱) ارسال ویدیو توسط کاربر برنده

### اندپوینت‌ها
- **POST `/winner-submissions/`**: ایجاد سابمیشن جدید و آپلود ویدیو.
- **GET `/winner-submissions/`**: مشاهده لیست سابمیشن‌ها. فقط ادمین، خالق تورنمنت و خود برنده می‌توانند رکوردهای مرتبط را ببینند.
- **POST `/winner-submissions/{id}/approve/`**: تایید سابمیشن (فقط خالق تورنمنت یا ادمین). پس از تایید، تسویه جایزه به‌صورت غیرهمزمان شروع می‌شود.
- **POST `/winner-submissions/{id}/reject/`**: رد سابمیشن (فقط خالق تورنمنت یا ادمین). در صورت رد، ورودی شرکت‌کننده بازپرداخت می‌شود.

### احراز هویت و سطح دسترسی
- تمام درخواست‌ها نیاز به توکن JWT دارند.
- فقط کاربری که واقعاً در فهرست برندگان تورنمنت است می‌تواند سابمیشن جدید ایجاد کند؛ در غیر این صورت خطای ولیدیشن دریافت می‌شود.
- ادمین دسترسی کامل دارد. خالق تورنمنت می‌تواند سابمیشن‌های تورنمنت خود را ببیند/تایید/رد کند. هر برنده فقط سابمیشن‌های خودش را می‌بیند.

### بدنه درخواست ایجاد (POST `/winner-submissions/`)
- باید با `multipart/form-data` ارسال شود.
- فیلدها:
  - `tournament` (عدد) – شناسه تورنمنت.
  - `video` (فایل) – ویدیو یا مدیای قابل آپلود.

### محدودیت فایل
- حداکثر حجم: **۱۰ مگابایت**.
- فرمت‌های مجاز: `.jpg`, `.jpeg`, `.png`, `.mp4`, `.mov`, `.webp`, `.gif`, `.heic`, `.avif`.
- در صورت عبور از محدودیت‌ها، پیام خطای ولیدیشن بازگشت داده می‌شود.

### ساختار پاسخ سابمیشن
نمونه پاسخ موفق هنگام ایجاد:
```json
{
  "id": 42,
  "winner": 7,
  "tournament": 15,
  "video": "https://example.com/media/winner_submissions/clip.mp4",
  "status": "pending",
  "created_at": "2024-05-01T12:30:00Z"
}
```
`status` یکی از `pending`، `approved` یا `rejected` است. پس از تایید/رد شدن، اعلان مناسب برای کاربر ارسال می‌شود.

## ۲) منطق تعیین برندگان تورنمنت

منطق بک‌اند برای تشخیص برندگان در تابع `get_tournament_winners` پیاده‌سازی شده است و بر اساس تعداد بردها کار می‌کند:

1. **تشخیص نوع تورنمنت**
   - `individual`: بر اساس کاربران (`User`) با بیشترین `won_matches` در آن تورنمنت.
   - `team`: بر اساس تیم‌ها (`Team`) با بیشترین `won_matches` در آن تورنمنت.

2. **تعیین سقف برندگان**
   - اگر تعداد شرکت‌کننده‌ها ≤ ۲ باشد، فقط **یک** برنده برگردانده می‌شود.
   - در غیر این صورت، تعداد برندگان برابر `winner_slots` تورنمنت است (حداقل ۱).

3. **مرتب‌سازی و تساوی**
   - برندگان بر اساس `num_wins` به‌صورت نزولی مرتب می‌شوند.
   - در صورت برابری تعداد برد، شناسه کوچک‌تر در اولویت قرار می‌گیرد.

4. **تطبیق با ارسال ویدیو**
   - در زمان ارسال ویدیو، برای تورنمنت فردی باید کاربر در فهرست خروجی `get_tournament_winners` باشد.
   - برای تورنمنت تیمی، کاپیتان یا هر عضو تیم برنده می‌تواند ویدیو بفرستد.

> نکته: پس از تایید سابمیشن، پرداخت جایزه آغاز و وضعیت سابمیشن به `approved` تغییر می‌کند؛ در حالت رد، ورودی‌ها بازپرداخت و وضعیت `rejected` می‌شود.
