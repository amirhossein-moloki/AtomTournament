# راهنمای ثبت برنده در تورنمنت

این راهنما مراحل ست کردن برنده در مسابقات کاربری و تیمی را توضیح می‌دهد.

## ثبت نتیجه مسابقه
- برنده (کاربر یا کپیتان تیم) درخواست `POST /api/tournaments/matches/{id}/submit_result/` را با مقدار `winner_id` برابر شناسه برنده و ضمیمه مدرک (`result_proof`) ارسال می‌کند. وضعیت مسابقه به `pending_confirmation` می‌رود.
- حریف نتیجه را با `POST /api/tournaments/matches/{id}/confirm_result/` تأیید می‌کند تا مسابقه به `completed` تغییر کند و برنده ثبت شود.
- در صورت اعتراض، حریف می‌تواند `POST /api/tournaments/matches/{id}/dispute_result/` بفرستد تا ادمین نتیجه را نهایی کند.

## ارسال ویدیو برای برندگان نهایی
- فقط برندگان مجاز (کاربران در تورنمنت‌های فردی یا اعضای تیم برنده در تورنمنت‌های تیمی) می‌توانند ویدیو را در `POST /api/tournaments/winner-submissions/` آپلود کنند. درخواست باید `multipart/form-data` با فیلدهای `tournament` و `video` باشد.
- خالق تورنمنت یا ادمین می‌تواند سابمیشن را با `POST /api/tournaments/winner-submissions/{id}/approve/` تأیید یا با `POST .../reject/` رد کند؛ در حالت تأیید پرداخت جایزه به صورت غیرهمزمان شروع می‌شود.

## منطق تعیین برندگان
تابع `get_tournament_winners` بر اساس بیشترین تعداد برد (`won_matches`) و محدودیت `winner_slots`، شرکت‌کنندگان را به ترتیب نزولی بردها و سپس شناسه کوچک‌تر مرتب می‌کند. در تورنمنت تیمی هر عضو تیم برنده می‌تواند ویدیو ارسال کند.

### نمونه: انتخاب ۵ نفر اول
- اگر `winner_slots` برابر ۵ باشد، تابع بالا پس از اتمام همه مسابقات لیست شرکت‌کنندگان را بر اساس تعداد برد مرتب می‌کند و ۵ نفر/تیم اول را برمی‌دارد (در صورت تعداد کمتر، همه برمی‌گردند).
- در صورت مساوی بودن تعداد برد، شرکت‌کننده با شناسه کوچک‌تر جلوتر قرار می‌گیرد؛ بنابراین ترتیب در دیتابیس تعیین‌کننده است و قرعه‌کشی نمی‌شود.
- هر یک از این ۵ نفر باید برای ثبت برنده شدن‌شان مدرک نتیجه مسابقه را در مرحله «ثبت نتیجه مسابقه» ارسال کرده باشند (با `result_proof`). سپس فقط همین ۵ نفر/تیم‌ها مجاز به آپلود ویدیو برنده در «ارسال ویدیو برای برندگان نهایی» هستند.

## تفاوت تورنمنت فردی و تیمی
- تورنمنت فردی: مقدار `winner_id` باید شناسه کاربر باشد و همان کاربر باید در خروجی `get_tournament_winners` قرار داشته باشد.
- تورنمنت تیمی: مقدار `winner_id` باید شناسه تیم باشد و هر عضو تیم برنده (مثلاً کپیتان) مجاز به ارسال ویدیو است.

## نکته برای فرانت‌اند
پس از تکمیل هر مسابقه، لیست برندگان مجاز را از بک‌اند بگیرید و فقط برای آن‌ها دکمه آپلود ویدیو نمایش دهید.
